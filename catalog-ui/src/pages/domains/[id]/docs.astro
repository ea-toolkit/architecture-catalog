---
import Layout from '../../../layouts/Layout.astro';
import { domains, getElementsByDomain, getDomainById, LAYER_META, TYPE_BADGES, eventMappingEnabled, type LayerKey } from '../../../data/registry';
import { getDiagramsByDomain } from '../../../data/diagrams-mock';
import { marked } from 'marked';

export function getStaticPaths() {
  return domains.map(d => ({ params: { id: d.id } }));
}

const { id } = Astro.params;
const domain = getDomainById(id!)!;
const domainElements = getElementsByDomain(id!);
const domainDiagrams = getDiagramsByDomain(id!);

// Group elements by layer → type (for sidebar)
type GroupedElements = Record<string, { type: string; typeLabel: string; badgeClass: string; elements: typeof domainElements }[]>;
const elementsByLayer: GroupedElements = {};

const typeToBadge = TYPE_BADGES;

for (const el of domainElements) {
  if (!elementsByLayer[el.layer]) elementsByLayer[el.layer] = [];
  const existing = elementsByLayer[el.layer].find(g => g.type === el.type);
  if (existing) {
    existing.elements.push(el);
  } else {
    elementsByLayer[el.layer].push({
      type: el.type, typeLabel: el.typeLabel,
      badgeClass: typeToBadge[el.type] || 'default',
      elements: [el],
    });
  }
}
---

<Layout title={`${domain.name} – Documentation`} activeDomain={id} sidebarContent="domain-detail">
  <!-- Sidebar slot: domain element navigation -->
  <Fragment slot="sidebar">
    <div class="sidebar-group">
      <div class="sidebar-group-header">
        <span class="sidebar-group-icon">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="4"/><path d="M12 2v4"/><path d="M12 18v4"/><path d="M4.93 4.93l2.83 2.83"/><path d="M16.24 16.24l2.83 2.83"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M4.93 19.07l2.83-2.83"/><path d="M16.24 7.76l2.83-2.83"/></svg>
        </span>
        <span class="sidebar-group-title">Overview</span>
      </div>
      <div class="sidebar-group-items">
        <a href={`/domains/${id}`} class="sidebar-item">
          <span>Architecture Overview</span>
        </a>
        <a href={`/domains/${id}/context-map`} class="sidebar-item">
          <span>Domain Context Map</span>
        </a>
        <a href={`/domains/${id}/docs`} class="sidebar-item active">
          <span>Documentation</span>
          {!domain.docs && <span class="sidebar-type-label" style="font-size: 9px; opacity: 0.5;">empty</span>}
        </a>
        {eventMappingEnabled && (
          <a href={`/domains/${id}/events`} class="sidebar-item">
            <span>Event Map</span>
          </a>
        )}
      </div>
    </div>

    {/* Diagrams section in sidebar */}
    {domainDiagrams.length > 0 && (
      <div class="sidebar-group">
        <div class="sidebar-group-header">
          <span class="sidebar-group-icon" style="background: #f59e0b15; color: #f59e0b;">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
          </span>
          <span class="sidebar-group-title">Diagrams</span>
        </div>
        <div class="sidebar-group-items">
          {domainDiagrams.map(d => (
            <a href={`/diagrams/${d.id}`} class="sidebar-item">
              <span style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{d.name}</span>
              <span class="sidebar-type-label">{d.format}</span>
            </a>
          ))}
        </div>
      </div>
    )}

    {Object.entries(elementsByLayer).map(([layerKey, groups]) => {
      const layer = LAYER_META[layerKey as LayerKey];
      return (
        <div class="sidebar-group">
          <div class="sidebar-group-header">
            <span class="sidebar-group-icon" style={`background: ${layer.color}15; color: ${layer.color};`}>
              <span style={`width: 8px; height: 8px; border-radius: 2px; background: ${layer.color};`}></span>
            </span>
            <span class="sidebar-group-title">{layer.name}</span>
          </div>
          <div class="sidebar-group-items">
            {groups.map(group => (
              group.elements.map(el => (
                <a href={`/catalog/${el.id}`} class="sidebar-item">
                  <span style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{el.name}</span>
                  <span class="sidebar-type-label">{group.typeLabel}</span>
                </a>
              ))
            ))}
          </div>
        </div>
      );
    })}
  </Fragment>

  <!-- Page Content -->
  <div class="page-header" style={`border-top: 3px solid ${domain.color};`}>
    <div class="page-header-breadcrumb">
      <a href="/">Domains</a>
      <span>/</span>
      <a href={`/domains/${id}`}>{domain.name}</a>
      <span>/</span>
    </div>
    <div class="page-header-title">
      <h1>Documentation</h1>
    </div>
    <p class="page-header-summary">{domain.name} domain documentation</p>
  </div>

  <div class="page-body">
    {domain.docs ? (
      <div class="detail-body" style="padding: 24px; background: rgb(var(--ec-content-hover)); border-radius: 10px; font-size: 14px; line-height: 1.7; color: rgb(var(--ec-page-text));">
        <Fragment set:html={marked(domain.docs)} />
      </div>
    ) : (
      <div style="padding: 40px 24px; text-align: center; background: rgb(var(--ec-content-hover)); border-radius: 10px; border: 1px dashed rgb(var(--ec-page-border));">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="rgb(var(--ec-page-text-muted))" stroke-width="1" style="margin: 0 auto 12px; display: block; opacity: 0.4;">
          <path d="M14.5 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V7.5L14.5 2z"/>
          <polyline points="14 2 14 8 20 8"/>
          <line x1="16" y1="13" x2="8" y2="13"/>
          <line x1="16" y1="17" x2="8" y2="17"/>
        </svg>
        <div style="font-size: 14px; font-weight: 500; color: rgb(var(--ec-page-text-muted)); margin-bottom: 6px;">No documentation yet</div>
        <div style="font-size: 12px; color: rgb(var(--ec-page-text-muted)); opacity: 0.7;">
          Add a <code style="background: rgb(var(--ec-page-border) / 0.4); padding: 1px 5px; border-radius: 4px; font-size: 11px;">docs.md</code> file at <code style="background: rgb(var(--ec-page-border) / 0.4); padding: 1px 5px; border-radius: 4px; font-size: 11px;">views/{id}/docs.md</code> to populate this section.
        </div>
      </div>
    )}
  </div>
</Layout>
