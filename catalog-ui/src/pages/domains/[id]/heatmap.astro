---
import Layout from '../../../layouts/Layout.astro';
import { domains, getElementsByDomain, getDomainById, LAYER_META, eventMappingEnabled, heatmapMappingEnabled, getHeatmapConfig, type LayerKey } from '../../../data/registry';
import { getDiagramsByDomain } from '../../../data/diagrams-mock';

export function getStaticPaths() {
  // Only generate heatmap pages if heatmap-mapping.yaml is configured
  if (!heatmapMappingEnabled) return [];
  return domains.map(d => ({ params: { id: d.id } }));
}

const { id } = Astro.params;
const domain = getDomainById(id!)!;
const domainElements = getElementsByDomain(id!);
const domainDiagrams = getDiagramsByDomain(id!);

// Load heatmap config from heatmap-mapping.yaml
const heatmapConfig = getHeatmapConfig()!;

// Filter to capabilities for this domain using configured type key
// Per Maps Architecture: map views CAN reference specific element types
const capabilities = domainElements.filter(el => el.type === heatmapConfig.capability_type);

// Maturity color scale (the "heat" dimension) — from mapping YAML
const maturityColors = heatmapConfig.maturity_scale;

// Size scale — from mapping YAML
const sizeScale = heatmapConfig.size_scale;

// Derive "mature" threshold from top half of maturity scale keys
const scaleKeys = Object.keys(maturityColors);
const matureThreshold = Math.ceil(scaleKeys.length / 2);
const matureKeys = new Set(scaleKeys.slice(0, matureThreshold));

// Luminance-based text color for treemap tiles
function getTextColor(hex: string): string {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
  return luminance > 0.55 ? '#1a1a2e' : '#ffffff';
}

// Group elements by layer → type (for sidebar)
type GroupedElements = Record<string, { type: string; typeLabel: string; elements: typeof domainElements }[]>;
const elementsByLayer: GroupedElements = {};

for (const el of domainElements) {
  if (!elementsByLayer[el.layer]) elementsByLayer[el.layer] = [];
  const existing = elementsByLayer[el.layer].find(g => g.type === el.type);
  if (existing) {
    existing.elements.push(el);
  } else {
    elementsByLayer[el.layer].push({
      type: el.type, typeLabel: el.typeLabel,
      elements: [el],
    });
  }
}
---

<Layout title={`${domain.name} – Capability Heatmap`} activeDomain={id} sidebarContent="domain-detail">
  <!-- Sidebar slot: domain element navigation -->
  <Fragment slot="sidebar">
    <div class="sidebar-group">
      <div class="sidebar-group-header">
        <span class="sidebar-group-icon">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="4"/><path d="M12 2v4"/><path d="M12 18v4"/><path d="M4.93 4.93l2.83 2.83"/><path d="M16.24 16.24l2.83 2.83"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M4.93 19.07l2.83-2.83"/><path d="M16.24 7.76l2.83-2.83"/></svg>
        </span>
        <span class="sidebar-group-title">Overview</span>
      </div>
      <div class="sidebar-group-items">
        <a href={`/domains/${id}`} class="sidebar-item">
          <span>Architecture Overview</span>
        </a>
        <a href={`/domains/${id}/docs`} class="sidebar-item">
          <span>Documentation</span>
        </a>
      </div>
    </div>

    {/* Maps section in sidebar */}
    <div class="sidebar-group">
      <div class="sidebar-group-header">
        <span class="sidebar-group-icon" style="background: #6366f115; color: #6366f1;">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
        </span>
        <span class="sidebar-group-title">Maps</span>
      </div>
      <div class="sidebar-group-items">
        <a href={`/domains/${id}/context-map`} class="sidebar-item">
          <span>Domain Context Map</span>
        </a>
        {eventMappingEnabled && (
          <a href={`/domains/${id}/events`} class="sidebar-item">
            <span>Event Map</span>
          </a>
        )}
        <a href={`/domains/${id}/heatmap`} class="sidebar-item active"><span>Capability Heatmap</span></a>
      </div>
    </div>

    {/* Diagrams section in sidebar */}
    {domainDiagrams.length > 0 && (
      <div class="sidebar-group">
        <div class="sidebar-group-header">
          <span class="sidebar-group-icon" style="background: #f59e0b15; color: #f59e0b;">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
          </span>
          <span class="sidebar-group-title">Diagrams</span>
        </div>
        <div class="sidebar-group-items">
          {domainDiagrams.map(d => (
            <a href={`/diagrams/${d.id}`} class="sidebar-item">
              <span style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{d.name}</span>
              <span class="sidebar-type-label">{d.format}</span>
            </a>
          ))}
        </div>
      </div>
    )}

    {Object.entries(elementsByLayer).map(([layerKey, groups]) => {
      const layer = LAYER_META[layerKey as LayerKey];
      return (
        <div class="sidebar-group">
          <div class="sidebar-group-header">
            <span class="sidebar-group-icon" style={`background: ${layer.color}15; color: ${layer.color};`}>
              <span style={`width: 8px; height: 8px; border-radius: 2px; background: ${layer.color};`}></span>
            </span>
            <span class="sidebar-group-title">{layer.name}</span>
          </div>
          <div class="sidebar-group-items">
            {groups.map(group => (
              group.elements.map(el => (
                <a href={`/catalog/${el.id}`} class="sidebar-item">
                  <span style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{el.name}</span>
                  <span class="sidebar-type-label">{group.typeLabel}</span>
                </a>
              ))
            ))}
          </div>
        </div>
      );
    })}
  </Fragment>

  <!-- Page Content -->
  <div class="page-header" style={`border-top: 3px solid ${domain.color};`}>
    <div class="page-header-breadcrumb">
      <a href="/">Domains</a>
      <span>/</span>
      <a href={`/domains/${id}`}>{domain.name}</a>
      <span>/</span>
    </div>
    <div class="page-header-title">
      <h1>Capability Heatmap</h1>
      <span class="badge badge-sm badge-capability">Capability Assessment</span>
    </div>
    <p class="page-header-summary">Business capability maturity and sourcing assessment for {domain.name}</p>
  </div>

  <div class="page-body">
    {capabilities.length > 0 ? (
      <>
        {/* Stats row */}
        <div class="stat-row">
          <div class="stat-card">
            <div class="stat-value" style="font-size: 24px;">{capabilities.length}</div>
            <div class="stat-label">Capabilities</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" style="font-size: 24px;">{capabilities.filter(c => matureKeys.has(c.fields[heatmapConfig.maturity_field] as string)).length}</div>
            <div class="stat-label">Mature ({Array.from(matureKeys).join('/')})</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" style="font-size: 24px;">{capabilities.filter(c => (c.fields[heatmapConfig.sourcing_field] as string) === 'in-house').length}</div>
            <div class="stat-label">In-House</div>
          </div>
          {heatmapConfig.realization_field && (
            <div class="stat-card">
              <div class="stat-value" style="font-size: 24px;">{capabilities.flatMap(c => c.relationships.filter(r => r.fieldKey === heatmapConfig.realization_field)).length}</div>
              <div class="stat-label">Realizing Components</div>
            </div>
          )}
        </div>

        {/* Heatmap Treemap */}
        <div class="detail-section">
          <div class="detail-section-title">Capability Heatmap</div>

          {/* Legend */}
          <div class="heatmap-legend">
            {Object.entries(maturityColors).map(([label, color]) => (
              <div class="heatmap-legend-item">
                <span class="heatmap-legend-swatch" style={`background: ${color};`}></span>
                <span>{label}</span>
              </div>
            ))}
          </div>

          {/* Treemap grid */}
          <div class="heatmap-treemap">
            {capabilities.map(cap => {
              const maturity = (cap.fields[heatmapConfig.maturity_field] as string) || scaleKeys.at(-1) || 'Initial';
              const lifecycle = cap.fields[heatmapConfig.lifecycle_field] as string;
              const sourcing = cap.fields[heatmapConfig.sourcing_field] as string;
              const size = (cap.fields[heatmapConfig.size_field] as string) || 'm';
              const bgColor = maturityColors[maturity] || '#94a3b8';
              const textColor = getTextColor(bgColor);
              const spec = sizeScale[size] || { cols: 2, rows: 1 };
              const realized = heatmapConfig.realization_field
                ? cap.relationships.filter(r => r.fieldKey === heatmapConfig.realization_field)
                : [];

              return (
                <a href={`/catalog/${cap.id}`}
                   class="heatmap-tile"
                   style={`grid-column: span ${spec.cols}; grid-row: span ${spec.rows}; background: ${bgColor}; color: ${textColor};`}>
                  <div class="heatmap-tile-name">{cap.name}</div>
                  <div class="heatmap-tile-maturity">{maturity}</div>
                  <div class="heatmap-tile-badges">
                    {lifecycle && <span class="heatmap-tile-badge">{lifecycle}</span>}
                    {sourcing && <span class="heatmap-tile-badge">{sourcing}</span>}
                  </div>
                  {cap.owner && <div class="heatmap-tile-owner">Owner: {cap.owner}</div>}
                  {realized.length > 0 && (
                    <div class="heatmap-tile-realized">
                      {realized.map(r => r.targetName).join(' · ')}
                    </div>
                  )}
                </a>
              );
            })}
          </div>
        </div>

        {/* Summary Table */}
        <div class="detail-section">
          <div class="detail-section-title">Capability Summary</div>
          <div style="border: 1px solid rgb(var(--ec-page-border)); border-radius: 10px; overflow-x: auto;">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Capability</th>
                  <th>Maturity</th>
                  <th>Lifecycle</th>
                  <th>Sourcing</th>
                  <th>Size</th>
                  {heatmapConfig.realization_field && <th>Realized By</th>}
                </tr>
              </thead>
              <tbody>
                {capabilities.map(cap => {
                  const maturity = (cap.fields[heatmapConfig.maturity_field] as string) || scaleKeys.at(-1) || 'Initial';
                  const lifecycle = cap.fields[heatmapConfig.lifecycle_field] as string;
                  const sourcing = cap.fields[heatmapConfig.sourcing_field] as string;
                  const size = (cap.fields[heatmapConfig.size_field] as string) || 'm';
                  const realized = heatmapConfig.realization_field
                    ? cap.relationships.filter(r => r.fieldKey === heatmapConfig.realization_field)
                    : [];
                  return (
                    <tr>
                      <td>
                        <a href={`/catalog/${cap.id}`} class="table-link">{cap.name}</a>
                        {cap.description && (
                          <div style="font-size: 11px; color: rgb(var(--ec-page-text-muted)); margin-top: 2px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            {cap.description}
                          </div>
                        )}
                      </td>
                      <td><span class={`badge badge-sm badge-${maturity.toLowerCase()}`}>{maturity}</span></td>
                      <td>
                        {lifecycle
                          ? <span class={`badge badge-sm badge-${lifecycle.toLowerCase()}`}>{lifecycle}</span>
                          : <span style="color: rgb(var(--ec-page-text-muted));">&mdash;</span>
                        }
                      </td>
                      <td>
                        {sourcing
                          ? <span class={`badge badge-sm badge-${sourcing.toLowerCase()}`}>{sourcing}</span>
                          : <span style="color: rgb(var(--ec-page-text-muted));">&mdash;</span>
                        }
                      </td>
                      <td><span style="font-size: 12px; text-transform: uppercase; font-weight: 600; letter-spacing: 0.05em; color: rgb(var(--ec-page-text-muted));">{size}</span></td>
                      {heatmapConfig.realization_field && (
                        <td style="font-size: 12px;">
                          {realized.length > 0
                            ? <span class="rel-cell-pills">{realized.map(r => <a href={`/catalog/${r.target}`} class="rel-pill rel-pill-out">{r.targetName}</a>)}</span>
                            : <span style="color: rgb(var(--ec-page-text-muted));">&mdash;</span>
                          }
                        </td>
                      )}
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      </>
    ) : (
      <div style="padding: 40px 24px; text-align: center; background: rgb(var(--ec-content-hover)); border-radius: 10px; border: 1px dashed rgb(var(--ec-page-border));">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="rgb(var(--ec-page-text-muted))" stroke-width="1" style="margin: 0 auto 12px; display: block; opacity: 0.4;">
          <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>
        </svg>
        <div style="font-size: 14px; font-weight: 500; color: rgb(var(--ec-page-text-muted)); margin-bottom: 6px;">No capabilities in this domain</div>
        <div style="font-size: 12px; color: rgb(var(--ec-page-text-muted)); opacity: 0.7;">
          Business capabilities will appear here when capability elements are registered for this domain.
        </div>
      </div>
    )}
  </div>
</Layout>

<style>
  /* Heatmap Legend */
  .heatmap-legend {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
    padding: 10px 16px;
    background: rgb(var(--ec-content-hover));
    border-radius: 8px;
    border: 1px solid rgb(var(--ec-page-border));
  }

  .heatmap-legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: rgb(var(--ec-page-text-muted));
    font-weight: 500;
  }

  .heatmap-legend-swatch {
    width: 14px;
    height: 14px;
    border-radius: 4px;
    flex-shrink: 0;
  }

  /* Heatmap Treemap Grid */
  .heatmap-treemap {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    grid-auto-flow: dense;
    gap: 8px;
  }

  .heatmap-tile {
    border-radius: 10px;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-height: 100px;
    text-decoration: none;
    transition: transform 0.15s, box-shadow 0.15s;
    overflow: hidden;
  }

  .heatmap-tile:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
  }

  .heatmap-tile-name {
    font-size: 15px;
    font-weight: 700;
    line-height: 1.3;
  }

  .heatmap-tile-maturity {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    opacity: 0.85;
  }

  .heatmap-tile-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 2px;
  }

  .heatmap-tile-badge {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.2);
    font-weight: 500;
    line-height: 1.4;
  }

  .heatmap-tile-owner {
    font-size: 11px;
    opacity: 0.7;
    margin-top: auto;
  }

  .heatmap-tile-realized {
    font-size: 11px;
    opacity: 0.75;
    border-top: 1px solid rgba(255, 255, 255, 0.15);
    padding-top: 6px;
    line-height: 1.4;
  }
</style>
