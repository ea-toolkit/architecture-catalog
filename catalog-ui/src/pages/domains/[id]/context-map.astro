---
import Layout from '../../../layouts/Layout.astro';
import { domains, getElementsByDomain, getDomainById, LAYER_META, TYPE_BADGES, eventMappingEnabled, type LayerKey } from '../../../data/registry';
import { getDiagramsByDomain } from '../../../data/diagrams-mock';
import DomainContextMap from '../../../components/graphs/DomainContextMap';

export function getStaticPaths() {
  return domains.map(d => ({ params: { id: d.id } }));
}

const { id } = Astro.params;
const domain = getDomainById(id!)!;
const domainElements = getElementsByDomain(id!);
const domainDiagrams = getDiagramsByDomain(id!);

// Group elements by layer → type (for sidebar)
type GroupedElements = Record<string, { type: string; typeLabel: string; badgeClass: string; elements: typeof domainElements }[]>;
const elementsByLayer: GroupedElements = {};

// Badge categories from mapping YAML
const typeToBadge = TYPE_BADGES;

for (const el of domainElements) {
  if (!elementsByLayer[el.layer]) elementsByLayer[el.layer] = [];
  const existing = elementsByLayer[el.layer].find(g => g.type === el.type);
  if (existing) {
    existing.elements.push(el);
  } else {
    elementsByLayer[el.layer].push({
      type: el.type, typeLabel: el.typeLabel,
      badgeClass: typeToBadge[el.type] || 'default',
      elements: [el],
    });
  }
}
---

<Layout title={`${domain.name} – Context Map`} activeDomain={id} sidebarContent="domain-detail">
  <!-- Sidebar slot: domain element navigation -->
  <Fragment slot="sidebar">
    <div class="sidebar-group">
      <div class="sidebar-group-header">
        <span class="sidebar-group-icon">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="4"/><path d="M12 2v4"/><path d="M12 18v4"/><path d="M4.93 4.93l2.83 2.83"/><path d="M16.24 16.24l2.83 2.83"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M4.93 19.07l2.83-2.83"/><path d="M16.24 7.76l2.83-2.83"/></svg>
        </span>
        <span class="sidebar-group-title">Overview</span>
      </div>
      <div class="sidebar-group-items">
        <a href={`/domains/${id}`} class="sidebar-item">
          <span>Architecture Overview</span>
        </a>
        <a href={`/domains/${id}/context-map`} class="sidebar-item active">
          <span>Domain Context Map</span>
        </a>
        <a href={`/domains/${id}/docs`} class="sidebar-item">
          <span>Documentation</span>
        </a>
        {eventMappingEnabled && (
          <a href={`/domains/${id}/events`} class="sidebar-item">
            <span>Event Map</span>
          </a>
        )}
      </div>
    </div>

    {/* Diagrams section in sidebar */}
    {domainDiagrams.length > 0 && (
      <div class="sidebar-group">
        <div class="sidebar-group-header">
          <span class="sidebar-group-icon" style="background: #f59e0b15; color: #f59e0b;">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
          </span>
          <span class="sidebar-group-title">Diagrams</span>
        </div>
        <div class="sidebar-group-items">
          {domainDiagrams.map(d => (
            <a href={`/diagrams/${d.id}`} class="sidebar-item">
              <span style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{d.name}</span>
              <span class="sidebar-type-label">{d.format}</span>
            </a>
          ))}
        </div>
      </div>
    )}

    {Object.entries(elementsByLayer).map(([layerKey, groups]) => {
      const layer = LAYER_META[layerKey as LayerKey];
      return (
        <div class="sidebar-group">
          <div class="sidebar-group-header">
            <span class="sidebar-group-icon" style={`background: ${layer.color}15; color: ${layer.color};`}>
              <span style={`width: 8px; height: 8px; border-radius: 2px; background: ${layer.color};`}></span>
            </span>
            <span class="sidebar-group-title">{layer.name}</span>
          </div>
          <div class="sidebar-group-items">
            {groups.map(group => (
              group.elements.map(el => (
                <a href={`/catalog/${el.id}`} class="sidebar-item">
                  <span style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{el.name}</span>
                  <span class="sidebar-type-label">{group.typeLabel}</span>
                </a>
              ))
            ))}
          </div>
        </div>
      );
    })}
  </Fragment>

  <!-- Full-page Context Map -->
  <div class="context-map-fullpage">
    <div class="context-map-header">
      <div class="context-map-header-left">
        <a href={`/domains/${id}`} class="context-map-back">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
          Back to Overview
        </a>
        <div class="context-map-title">
          <span class="context-map-domain-dot" style={`background: ${domain.color};`}></span>
          <h1>{domain.name}</h1>
          <span class="badge badge-sm badge-domain">Context Map</span>
        </div>
      </div>
      <div class="context-map-header-right">
        <span style="font-size: 12px; color: rgb(var(--ec-page-text-muted));">
          {domainElements.length} elements
        </span>
      </div>
    </div>

    <div class="context-map-container">
      <DomainContextMap 
        client:only="react" 
        domain={domain} 
        elements={domainElements} 
      />
    </div>

    <div class="context-map-footer">
      <p>Click any node to enter focus mode. Click the document icon to view element details.</p>
    </div>
  </div>
</Layout>

<style>
  .context-map-fullpage {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 20px);
    background: rgb(var(--ec-page-bg));
    overflow: hidden;
  }

  .context-map-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 24px;
    border-bottom: 1px solid rgb(var(--ec-page-border));
    background: rgb(var(--ec-page-surface));
    flex-shrink: 0;
  }

  .context-map-header-left {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .context-map-back {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: rgb(var(--ec-page-text-muted));
    text-decoration: none;
    transition: color 0.15s;
  }

  .context-map-back:hover {
    color: rgb(59, 130, 246);
  }

  .context-map-title {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .context-map-domain-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .context-map-title h1 {
    font-size: 18px;
    font-weight: 600;
    margin: 0;
    color: rgb(var(--ec-page-text));
  }

  .context-map-container {
    flex: 1;
    min-height: 0;
    position: relative;
    display: flex;
    flex-direction: column;
  }

  /* Make the ReactFlow container fill available space */
  .context-map-container > div {
    flex: 1;
    min-height: 0;
  }

  .context-map-footer {
    padding: 8px 24px;
    border-top: 1px solid rgb(var(--ec-page-border));
    background: rgb(var(--ec-page-surface));
    flex-shrink: 0;
  }

  .context-map-footer p {
    font-size: 12px;
    color: rgb(var(--ec-page-text-muted));
    margin: 0;
    text-align: center;
  }
</style>
